{% extends "base.html" %}

{% block title %}
{% if mode == 'add' %}Add Data Point{% else %}Edit Data Point{% endif %} - {{ indicator.title }}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('indicators') }}">Indicators</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('indicator_data_list', indicator_id=indicator.id) }}">{{ indicator.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if mode == 'add' %}Add Data Point{% else %}Edit Data Point{% endif %}
            </li>
        </ol>
    </nav>

    <!-- Form Card -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">
                <i class="bi bi-{% if mode == 'add' %}plus-circle{% else %}pencil{% endif %}"></i>
                {% if mode == 'add' %}Add Data Point{% else %}Edit Data Point{% endif %}
            </h4>
            <div class="text-muted">{{ indicator.title }}</div>
        </div>
        <div class="card-body">
            <form method="POST">
                <!-- Date Field -->
                <div class="mb-3">
                    <label for="date" class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" 
                           class="form-control" 
                           id="date" 
                           name="date" 
                           value="{% if data_point %}{{ data_point.date }}{% endif %}"
                           required
                           max="{{ today }}">
                    <div class="form-text">
                        Select the date for this data point. Cannot be in the future.
                    </div>
                </div>

                <!-- Value Field -->
                <div class="mb-3">
                    <label for="value" class="form-label">Value <span class="text-danger">*</span></label>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="number" 
                                   class="form-control" 
                                   id="value" 
                                   name="value" 
                                   value="{% if data_point %}{{ data_point.value }}{% else %}0.0{% endif %}"
                                   step="0.001"
                                   min="-1.0"
                                   max="1.0"
                                   required>
                        </div>
                        <div class="col-md-8">
                            <input type="range" 
                                   class="form-range mt-2" 
                                   id="valueSlider" 
                                   min="-1.0" 
                                   max="1.0" 
                                   step="0.01"
                                   value="{% if data_point %}{{ data_point.value }}{% else %}0.0{% endif %}">
                        </div>
                    </div>
                    <div class="form-text mb-2">
                        Value must be between -1.0 and 1.0 (inclusive)
                    </div>
                    
                    <!-- Visual Indicator -->
                    <div class="card bg-light">
                        <div class="card-body p-3">
                            <div class="small fw-bold mb-2">Visual Preview:</div>
                            <div class="position-relative" style="height: 40px; background: linear-gradient(to right, #dc3545 0%, #ffc107 25%, #6c757d 50%, #20c997 75%, #198754 100%); border-radius: 8px;">
                                <!-- Marker -->
                                <div id="valueMarker" 
                                     class="position-absolute top-50 translate-middle bg-dark" 
                                     style="width: 4px; height: 100%; border: 2px solid white; border-radius: 2px; transition: left 0.2s;">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-2 small">
                                <span class="text-danger fw-bold">-1.0<br><small>Bearish</small></span>
                                <span class="text-warning fw-bold">-0.5</span>
                                <span class="text-muted fw-bold">0.0<br><small>Neutral</small></span>
                                <span class="text-info fw-bold">0.5</span>
                                <span class="text-success fw-bold">1.0<br><small>Bullish</small></span>
                            </div>
                            <div class="text-center mt-2">
                                <span class="badge bg-secondary fs-6" id="currentValue">
                                    {% if data_point %}{{ "%.3f"|format(data_point.value) }}{% else %}0.000{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metadata (Edit Mode Only) -->
                {% if mode == 'edit' and data_point %}
                <div class="mb-3">
                    <div class="alert alert-info">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Created:</strong> {{ data_point.created_at if data_point.created_at else 'N/A' }}
                            </div>
                            <div class="col-md-6">
                                <strong>Last Updated:</strong> {{ data_point.updated_at if data_point.updated_at else 'N/A' }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i>
                        {% if mode == 'add' %}Add Data Point{% else %}Update Data Point{% endif %}
                    </button>
                    <a href="{{ url_for('indicator_data_list', indicator_id=indicator.id) }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tips Card -->
    <div class="card mt-3">
        <div class="card-body">
            <h6 class="card-title"><i class="bi bi-lightbulb"></i> Tips</h6>
            <ul class="mb-0 small">
                <li><strong>Value Range:</strong> Use -1.0 for extremely bearish, 0.0 for neutral, and 1.0 for extremely bullish</li>
                <li><strong>Consistency:</strong> Try to use consistent criteria when assigning values for better trend analysis</li>
                <li><strong>Duplicate Dates:</strong> Each indicator can only have one data point per date</li>
                <li><strong>Updates:</strong> You can edit values later if your assessment changes</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // Sync slider and input
    const valueInput = document.getElementById('value');
    const valueSlider = document.getElementById('valueSlider');
    const valueMarker = document.getElementById('valueMarker');
    const currentValue = document.getElementById('currentValue');

    function updateMarkerPosition(value) {
        const percentage = ((parseFloat(value) + 1.0) / 2.0) * 100;
        valueMarker.style.left = percentage + '%';
        currentValue.textContent = parseFloat(value).toFixed(3);
        
        // Update badge color
        if (value > 0.5) {
            currentValue.className = 'badge bg-success fs-6';
        } else if (value > 0) {
            currentValue.className = 'badge bg-info fs-6';
        } else if (value == 0) {
            currentValue.className = 'badge bg-secondary fs-6';
        } else if (value > -0.5) {
            currentValue.className = 'badge bg-warning fs-6';
        } else {
            currentValue.className = 'badge bg-danger fs-6';
        }
    }

    valueInput.addEventListener('input', function() {
        let val = parseFloat(this.value);
        if (val < -1.0) val = -1.0;
        if (val > 1.0) val = 1.0;
        this.value = val;
        valueSlider.value = val;
        updateMarkerPosition(val);
    });

    valueSlider.addEventListener('input', function() {
        valueInput.value = parseFloat(this.value).toFixed(3);
        updateMarkerPosition(this.value);
    });

    // Set today's date as max
    const dateInput = document.getElementById('date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.max = today;
    
    // If no date set (add mode), default to today
    {% if mode == 'add' %}
    if (!dateInput.value) {
        dateInput.value = today;
    }
    {% endif %}

    // Initialize marker position
    updateMarkerPosition(valueInput.value);
</script>
{% endblock %}
