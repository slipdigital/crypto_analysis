{% extends 'base.html' %}

{% block title %}{{ update_name }} Progress{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-arrow-repeat"></i> {{ update_name }}
        </h1>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span id="status-icon" class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span id="status-text">Running...</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">
                            <span id="progress-text">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-dark text-light">
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <pre id="output" class="mb-0 text-light" style="font-size: 0.875rem;"></pre>
                    </div>
                </div>
                
                <div id="completion-actions" class="mt-3" style="display: none;">
                    <a href="{% url 'data_updates' %}" class="btn btn-primary">
                        <i class="bi bi-arrow-left"></i> Back to Data Updates
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const taskId = '{{ task_id }}';
const statusUrl = '/data-updates/status/' + taskId + '/';
let lastOutputLength = 0;
let pollInterval;

function updateProgress() {
    fetch(statusUrl)
        .then(response => response.json())
        .then(data => {
            // Update output if changed
            if (data.output && data.output.length > lastOutputLength) {
                document.getElementById('output').textContent = data.output;
                lastOutputLength = data.output.length;
                
                // Auto-scroll to bottom
                const outputElement = document.getElementById('output').parentElement;
                outputElement.scrollTop = outputElement.scrollHeight;
            }
            
            // Update status
            if (data.status === 'completed') {
                clearInterval(pollInterval);
                document.getElementById('status-icon').className = 'bi bi-check-circle-fill text-success me-2';
                document.getElementById('status-text').textContent = 'Completed Successfully!';
                document.getElementById('progress-bar').className = 'progress-bar bg-success';
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-text').textContent = '100%';
                document.getElementById('completion-actions').style.display = 'block';
            } else if (data.status === 'failed') {
                clearInterval(pollInterval);
                document.getElementById('status-icon').className = 'bi bi-x-circle-fill text-danger me-2';
                document.getElementById('status-text').textContent = 'Failed';
                document.getElementById('progress-bar').className = 'progress-bar bg-danger';
                document.getElementById('completion-actions').style.display = 'block';
                
                if (data.error) {
                    document.getElementById('output').textContent += '\n\nERROR: ' + data.error;
                }
            } else if (data.status === 'not_found') {
                clearInterval(pollInterval);
                document.getElementById('status-icon').className = 'bi bi-question-circle-fill text-warning me-2';
                document.getElementById('status-text').textContent = 'Task Not Found';
                document.getElementById('progress-bar').className = 'progress-bar bg-warning';
                document.getElementById('completion-actions').style.display = 'block';
            }
            
            // Update progress bar (estimate based on output length)
            if (data.status === 'running' && data.output) {
                // Simple heuristic: progress based on output lines
                const lines = data.output.split('\n').length;
                const estimatedProgress = Math.min(90, lines * 2); // Cap at 90% until complete
                document.getElementById('progress-bar').style.width = estimatedProgress + '%';
                document.getElementById('progress-text').textContent = estimatedProgress + '%';
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
        });
}

// Start polling
updateProgress(); // Initial call
pollInterval = setInterval(updateProgress, 1000); // Poll every second

// Stop polling when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        clearInterval(pollInterval);
    } else {
        pollInterval = setInterval(updateProgress, 1000);
    }
});
</script>

{% endblock %}
